<!DOCTYPE html>
<html>
  <head>
    <title>Bulk LLM TTS</title>
  </head>
  <body>
    <input type="text" id="prompt" name="prompt" placeholder="Enter your prompt here..." required>
    <textarea id="content" name="content" rows="4" cols="50" placeholder="Enter your content here..."></textarea>
    <button onclick="submitQueries()">Submit</button>
    <table id="results">
      <thead>
        <tr>
          <th>Prompt</th>
          <th>Content</th>
          <th>Response</th>
          <th>Audio</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <script>
function handleQueryError(error, line, resultsBody) {
  console.error(`Error submitting query for line: ${line}:`, error);
  let row = resultsBody.insertRow();
  let errorCell = row.insertCell();
  errorCell.colSpan = 4;
  errorCell.innerHTML = `Error processing line: ${line} - ${error}`;
}

function processLine(line, promptText, resultsBody) {
  try {
    fetch('/query', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        prompt: promptText,
        line: line,
      })
    })
      .then(response => {
        response.json()
          .then(data => {
            console.log(`Response for line: ${line}`, data);
            let row = resultsBody.insertRow();
            let promptCell = row.insertCell();
            let contentCell = row.insertCell();
            let responseCell = row.insertCell();
            let audioCell = row.insertCell();

            promptCell.innerHTML = promptText;
            contentCell.innerHTML = line;
            responseCell.innerHTML = data.response;
            audioCell.innerHTML = `<audio controls src="${data.filePath}"></audio>`;
          })
      })
      .catch(error => {
        handleQueryError(error, line, resultsBody);
      });

  } catch (error) {
    handleQueryError(error, line, resultsBody);
  }
}

function processLines(lines, promptText, resultsBody, timeout) {
  if (lines.length === 0) return;

  const line = lines.shift();
  processLine(line, promptText, resultsBody);

  setTimeout(() => {
    processLines(lines, promptText, resultsBody, timeout);
  }, timeout);
}

function submitQueries() {
  const promptText = document.getElementById("prompt").value;
  const lines = document.getElementById("content").value.split('\n').filter(line => line.trim() !== '');
  const resultsTable = document.getElementById("results");
  const resultsBody = resultsTable.querySelector("tbody");

  processLines(lines, promptText, resultsBody, 4000);
}
    </script>
  </body>
</html>
